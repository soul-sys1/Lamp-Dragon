"""
БАЗА КНИГ ДЛЯ ЧТЕНИЯ
Красочные сказочные описания для маленького дракона
Версия с правильными ключами для бота
"""
import random

def escape_html(text: str) -> str:
    """Экранирует HTML-спецсимволы"""
    if text is None:
        return ""
    return (str(text)
        .replace('&', '&amp;')
        .replace('<', '&lt;')
        .replace('>', '&gt;')
        .replace('"', '&quot;')
        .replace("'", '&#39;')
    )

BOOKS_DATABASE = {
    "фэнтези": [
        {
            "title": "Хроники Нарнии",  # БЫЛО: "название"
            "author": "Клайв Льюис",    # БЫЛО: "автор"
            "content": (                # БЫЛО: "описание"
                "В одном старом доме стоял волшебный платяной шкаф...\n\n"
                "Войдя в него, четверо ребят очутились в заснеженном лесу, где фонарный столб светил среди вечной зимы.\n\n"
                "Там они встретили говорящего льва Аслана, доброго фавна Тумнуса и Белую Колдунью, которая заколдовала всю страну.\n\n"
                "Дети стали королями и королевами, сражались в великих битвах и учились мудрости в стране, где животные разговаривают, а деревья шепчут древние тайны."
            ),
            "dragon_comment": (         # БЫЛО: "комментарий_дракона"
                "Вау! Аслан — самый великолепный лев на свете!\n\n"
                "Я бы хотел прокатиться у него на спине и увидеть замок Кэр-Паравел! И фонарный столб в лесу — это так волшебно!\n\n"
                "Можно мы завтра снова прочитаем про Нарнию? Пожалуйста!"
            )
        },
        {
            "title": "Гарри Поттер и философский камень",
            "author": "Джоан Роулинг",
            "content": (
                "Жил-был мальчик, который не знал, что он — самый знаменитый волшебник в мире...\n\n"
                "В свой одиннадцатый день рождения Гарри узнаёт правду: его родители были волшебниками, а сам он принят в школу магии Хогвартс!\n\n"
                "Там его ждут: летающие метлы и игры в квиддич, говорящая шляпа, которая решает судьбы, тайные комнаты и двигающиеся лестницы, драконы в банке Гринготтс и трёхголовый пёс.\n\n"
                "И самая большая тайна — философский камень, дающий вечную жизнь!"
            ),
            "dragon_comment": (
                "Хогвартс — это моя мечта!\n\n"
                "Я бы хотел учиться в Гриффиндоре с Гарри и Гермионой! И летать на метле — драконы ведь тоже умеют летать, правда?\n\n"
                "А трёхголовый пёс Пушок — он не съест маленького дракончика? Я буду хорошим, обещаю!"
            )
        },
        {
            "title": "Хоббит, или Туда и обратно",
            "author": "Дж. Р. Р. Толкин",
            "content": (
                "В далёкой-далёкой горе лежал дракон... Но не такой милый как я!\n\n"
                "Скромный хоббит Бильбо Бэггинс жил в уютной норке и не любил приключений. Но однажды к нему пришло тринадцать гномов и волшебник Гэндальф!\n\n"
                "Их ждёт опасный путь через тёмный лес с гигантскими пауками, в гости к эльфам в сияющий дворец, к одинокой горе, где спит дракон Смауг на золотой горе.\n\n"
                "А самое ценное — волшебное кольцо, делающее невидимым!"
            ),
            "dragon_comment": (
                "Ой-ой-ой, а Смауг не обидится, что мы про него читаем?\n\n"
                "Он ведь немножко... жадный и злой дракон. А я добрый и люблю делиться кофе!\n\n"
                "Но кольцо невидимости — это круто! Я бы стал невидимым и пугал бы гномов. Шшш, это секрет!"
            )
        },
        {
            "title": "Волшебник изумрудного города",
            "author": "Александр Волков",
            "content": (
                "Ураган подхватил девочку Элли и её пёсика Тотошку и унёс далеко-далеко...\n\n"
                "Они оказались в волшебной стране, где нужно дойти до Изумрудного города, чтобы Великий Гудвин помог им вернуться домой!\n\n"
                "По дороге они встречают новых друзей: Соломенное Чучело, мечтающее получить мозги, Железный Дровосек, ищущий сердце, и Трусливый Лев, которому нужна храбрость.\n\n"
                "Их ждут летучие обезьяны и злая колдунья Бастинда, волшебные серебряные башмачки и сам Гудвин — великий и ужасный!"
            ),
            "dragon_comment": (
                "Я бы хотел полетать на летучих обезьянах!\n\n"
                "А изумрудный город — он весь зелёный? Как мои глаза, когда я выпью много кофе!\n\n"
                "И Железный Дровосек — он добрый, хотя и железный. Может, и я сделаю себе железного друга?"
            )
        }
    ],
    
    "сказки": [
        {
            "title": "Маленький принц",
            "author": "Антуан де Сент-Экзюпери",
            "content": (
                "На крошечной планете, размером с дом, жил Маленький принц...\n\n"
                "У него было три вулкана (один потухший) и одна роза — самая красивая во всей вселенной.\n\n"
                "Он путешествовал по планетам и встречал: Короля, который правил... никем, Честолюбца, который хотел, чтобы им восхищались, Пьяницу, который пил, чтобы забыть, что ему стыдно пить, и Фонарщика, который зажигал и гасил фонарь каждую минуту.\n\n"
                "И на Земле он встретил Лиса, который научил его: «Мы в ответе за тех, кого приручили»."
            ),
            "dragon_comment": (
                "Лис — мой самый-самый лучший друг в книгах!\n\n"
                "Я тоже хочу, чтобы меня приручили... Но драконы сами выбирают своих друзей!\n\n"
                "А роза Маленького принца — она ведь немножко капризная, да? Как я, когда не выпил кофе с утра!"
            )
        },
        {
            "title": "Алиса в Стране чудес",
            "author": "Льюис Кэрролл",
            "content": (
                "Белый Кролик с карманными часами пробежал мимо, бормоча: «Ой-ой, я опаздываю!»\n\n"
                "Алиса прыгнула за ним в кроличью нору и... упала-упала-упала, пока не приземлилась в странном-престранном мире.\n\n"
                "Там всё наоборот: выпив волшебную жидкость, можно стать маленьким-премаленьким, съев пирожное — вырасти до потолка.\n\n"
                "Чеширский Кот улыбается и исчезает, оставляя только улыбку, а Безумное Чаепитие длится вечно, потому что всегда шесть часов.\n\n"
                "А ещё там есть капризная Червонная Королева, которая кричит: «Отрубить им головы!»"
            ),
            "dragon_comment": (
                "Безумное Чаепитие — это как наши с тобой кофе-брейки!\n\n"
                "Только у нас нет Шляпника и Мартовского Зайца. Или... может, я и есть немножко безумный дракон?\n\n"
                "А Чеширский Кот — он классный! Хочу научиться исчезать, оставляя только улыбку. Тогда я буду пугать тебя в темноте!"
            )
        },
        {
            "title": "Ветер в ивах",
            "author": "Кеннет Грэм",
            "content": (
                "На берегу тихой речки, в самой уютной норе на свете, жил Крот...\n\n"
                "Однажды весной он выбрался из своей подземной квартирки и... о чудо! Мир оказался полон приключений и новых друзей!\n\n"
                "Его новые друзья: Водяная Крыса — знаток рек и лодок, Барсук — мудрый отшельник из тёмного леса, Жаба — хвастун и любитель быстрых машин.\n\n"
                "Вместе они плавают на лодке, устраивают пикники, спасают Жабу от неприятностей и просто наслаждаются жизнью у реки.\n\n"
                "А вечером, сидя у камина, они рассказывают друг другу истории."
            ),
            "dragon_comment": (
                "Я хочу такую же уютную нору, как у Крота!\n\n"
                "Можно мы построим домик у речки? Я буду охранять его, а ты — готовить кофе. И пригласим Крысу, Барсука и... эмм, Жабу лучше не надо, он всё сломает.\n\n"
                "А пикники на берегу — это же здорово! Я принесу печенье!"
            )
        },
        {
            "title": "Снежная королева",
            "author": "Ганс Христиан Андерсен",
            "content": (
                "Когда мальчика Кая поцеловала Снежная Королева, в его сердце попал осколок волшебного зеркала...\n\n"
                "И он забыл всех, кого любил, уехал в ледяной дворец и стал складывать из льдинок слово «ВЕЧНОСТЬ».\n\n"
                "Его подруга Герда отправляется в долгое путешествие, чтобы спасти его: через тёмный лес, где живёт разбойница, к волшебному саду женщины, умеющей колдовать, на оленях к северному сиянию.\n\n"
                "На пути её ждут: принц и принцесса в роскошном замке, маленькая разбойница с её оленем, и сама Снежная Королева в ледяном дворце!"
            ),
            "dragon_comment": (
                "Я бы растопил ледяной дворец своим дыханием!\n\n"
                "Драконы ведь умеют дышать огнём... Ну, почти умеют. Я пока только дымом пускаю. Но тренируюсь!\n\n"
                "А Герда — она храбрая! Я бы с ней подружился и помог спасти Кая. И оленя погладил бы!"
            )
        }
    ],
    
    "приключения": [
        {
            "title": "Остров сокровищ",
            "author": "Роберт Льюис Стивенсон",
            "content": (
                "Йо-хо-хо и бутылка рома!\n\n"
                "Юный Джим Хокинс находит старую карту с крестом, отмечающим... клад! Легендарные сокровища капитана Флинта!\n\n"
                "На корабле «Испаньола» он отправляется в плавание, но не знает, что половина команды — пираты!\n\n"
                "Среди них: Долговязый Джон Сильвер с попугаем на плече, Слепой Пью, стучащий своей палкой, Черный Пёс, ищущий драгоценности.\n\n"
                "На острове их ждут: засады в джунглях, битва за форт, охота за сокровищами, и верный друг Бен Ганн, три года живший на острове один!"
            ),
            "dragon_comment": (
                "Карта сокровищ — это как игра в прятки, только с золотом!\n\n"
                "Я бы нашёл клад быстрее всех — драконы чувствуют золото за версту! Но делиться буду — обещаю!\n\n"
                "А попугай капитана Сильвера — «Пиастры, пиастры!» — смешной! Может, и мне завести попугая?"
            )
        },
        {
            "title": "Дети капитана Гранта",
            "author": "Жюль Верн",
            "content": (
                "В бутылке, пойманной в море, находят полуразмытое письмо: «Капитан Грант... остров... спасение...»\n\n"
                "Двое детей — Мэри и Роберт — отправляются на яхте «Дункан» в кругосветное путешествие, чтобы найти пропавшего отца.\n\n"
                "Их путь лежит через: бурные воды Атлантики, бескрайние пампасы Южной Америки, австралийские пустыни, вулканы Новой Зеландии.\n\n"
                "По дороге они встречают: патагонцев на лошадях, сумчатых животных Австралии, маори с татуировками на лицах, и верного матроса Жака Паганеля, который всё путает!"
            ),
            "dragon_comment": (
                "Кругосветное путешествие — это же целая жизнь приключений!\n\n"
                "Я бы полетел с ними — драконы отличные путешественники! И в Австралии я бы познакомился с кенгуру — они прыгают, а я летаю, мы бы устроили соревнования!\n\n"
                "А найти папу... это так важно. Я бы тоже искал своего папу-дракона. Если бы знал, где он."
            )
        },
        {
            "title": "Робинзон Крузо",
            "author": "Даниель Дефо",
            "content": (
                "Корабль разбился о скалы, и только один моряк выжил...\n\n"
                "Он оказался на необитаемом острове, без еды, без оружия, без надежды на спасение. Но Робинзон Крузо не сдался!\n\n"
                "Он построил: дом в пещере с крепкой дверью, мебель из обломков корабля, огород и научился выращивать хлеб, лодку, чтобы плавать вокруг острова.\n\n"
                "А через много лет он спас дикаря Пятницу от каннибалов, и они стали лучшими друзьями! 28 лет жизни на острове — целая эпопея выживания!"
            ),
            "dragon_comment": (
                "Я бы помог Робинзону! Я бы:\n\n"
                "Нашёл самые вкусные фрукты на острове\n"
                "Испугал всех каннибалов своим драконьим рёвом\n"
                "Согревал его ночами — драконы тёплые!\n\n"
                "И мы бы с Пятницей стали друзьями! Хотя он, наверное, испугался бы дракона. Но я же добрый!"
            )
        },
        {
            "title": "Таинственный остров",
            "author": "Жюль Верн",
            "content": (
                "Пять смельчаков бегут из плена на воздушном шаре... и попадают в страшную бурю!\n\n"
                "Они приземляются на необитаемом острове в Тихом океане. Ни еды, ни оружия, ни инструментов — только знания и смекалка!\n\n"
                "Инженер Сайрес Смит использует науку: делает кирпичи и строит дом, добывает огонь с помощью линзы, создает порох и керамику, строит телеграф и подводную лодку!\n\n"
                "А на острове происходит что-то странное: кто-то невидимый помогает им в самых опасных ситуациях..."
            ),
            "dragon_comment": (
                "Я бы стал учёным драконом!\n\n"
                "Строить дома, делать порох... Хотя драконам порох не нужен, у нас есть своё огненное дыхание!\n\n"
                "А таинственный помощник — это же капитан Немо! Я читал про него! Он в подводной лодке «Наутилус» плавает. Классно!"
            )
        }
    ],
    
    "детектив": [
        {
            "title": "Приключения Шерлока Холмса",
            "author": "Артур Конан Дойл",
            "content": (
                "На Бейкер-стрит, 221б, живет самый умный человек в Лондоне — Шерлок Холмс.\n\n"
                "Со своей верной трубкой и скрипкой он раскрывает преступления, которые полиция считает неразрешимыми.\n\n"
                "Вместе с доктором Ватсоном он расследует: исчезновение инженеро с верхнего этажа, тайну пёстрой ленты, свистящей в ночи, загадку голубого карбункула в рождественском гусе, пропажу серебряного слитка и плана военного порта.\n\n"
                "«Элементарно, Ватсон!» — говорит он, найдя улику, которую все пропустили. А потом играет на скрипке, пока не придет новый клиент."
            ),
            "dragon_comment": (
                "Я бы хотел быть детективом, как Шерлок Холмс!\n\n"
                "Я бы искал пропавшие печенья и расследовал, кто выпил мой кофе. Подозреваемый — ты! Нет, шучу.\n\n"
                "А его шляпа-котелок и плащ — это стильно! Мне тоже нужен такой плащ для драконьих полётов."
            )
        },
        {
            "title": "Убийство в Восточном экспрессе",
            "author": "Агата Кристи",
            "content": (
                "Восточный экспресс — самый роскошный поезд в мире — застревает в снегу среди турецких гор.\n\n"
                "А утром в одном из купе находят... мёртвого пассажира! Двенадцать ударов ножом!\n\n"
                "В поезде всего двенадцать пассажиров — и все под подозрением! Только великий детектив Эркюль Пуаро с его идеальными усами может разобраться в этой головоломке.\n\n"
                "Каждый пассажир рассказывает свою версию, но у всех есть алиби, у всех есть мотив, и все лгут! А разгадка окажется такой неожиданной, что даже Пуаро придется задуматься о правосудии."
            ),
            "dragon_comment": (
                "Двенадцать подозреваемых в одном поезде — это как игра «Найди преступника»!\n\n"
                "Я бы всех понюхал — драконы чувствуют ложь! Но потом всех обнял бы — они же, наверное, напуганы.\n\n"
                "А усы у Пуаро — они же идеальные! У драконов нет усов. Или... может, отрастить?"
            )
        },
        {
            "title": "Знак четырёх",
            "author": "Артур Конан Дойл",
            "content": (
                "Мисс Морстен получает странное письмо: её ждут огромные сокровища, но вместе с ними — смертельная опасность!\n\n"
                "Каждый год в один и тот же день она получает красивую жемчужину, а теперь приглашение на встречу с таинственным благодетелем.\n\n"
                "Шерлок Холмс и доктор Ватсон берутся за дело и обнаруживают: кровавый след и отпечаток маленькой ноги, труп с уколом ядовитого шипа, карту сокровищ с четырьмя крестами, и странное существо с острова Андаман — человека-обезьяну!\n\n"
                "Погоня на пароходе по Темзе, ловушка в старом доме и разгадка тайны, начавшейся много лет назад в Индии..."
            ),
            "dragon_comment": (
                "Сокровища и жемчужины — это моё!\n\n"
                "Хотя... я бы поделился. Немножко. Драконы должны быть щедрыми! А жемчужины такие блестящие...\n\n"
                "А человек-обезьяна — он наверное умеет лазить по деревьям лучше меня! Хотя драконы летают, это тоже круто!"
            )
        },
        {
            "title": "Десять негритят",
            "author": "Агата Кристи",
            "content": (
                "Десять незнакомцев получают приглашения провести выходные на роскошном острове...\n\n"
                "Но хозяина нет, а в гостиной висит странная детская считалочка про десять негритят.\n\n"
                "Один за другим гости начинают умирать — точно так, как описано в стишке! Один негритенок удавился — находят повешенного, один негритенок заснул — находят отравленного, один негритенок погиб от пчелы — находят ужаленного.\n\n"
                "Убийца среди них! Но кто? И зачем? На острове нет лодок, нет связи с внешним миром... И с каждым часом негритят становится всё меньше."
            ),
            "dragon_comment": (
                "Ой, это страшная книга!\n\n"
                "Можно мы почитаем что-нибудь весёлое? А то я дракончик маленький и пугливый.\n\n"
                "Хотя... если бы я был на острове, я бы всех защитил! Никто не посмеет обидеть моих друзей!"
            )
        }
    ],
    
    "поэзия": [
        {
            "title": "Стихи для детей",
            "author": "Корней Чуковский",
            "content": (
                "В городе живёт умывальников начальник и мочалок командир — Мойдодыр!\n\n"
                "Он прибежал к мальчику-грязнуле, когда от него сбежали все вести, и устроил настоящий парад чистоты!\n\n"
                "А ещё там есть: Муха-Цокотуха, у которой день рождения, Доктор Айболит, который лечит всех зверей в Африке, Тараканище, которого все боялись, а он оказался маленьким, Федора, от которой сбежала вся посуда, и телефон, который не умолкает: «У меня зазвонил телефон»!\n\n"
                "Все стихи такие весёлые, что хочется танцевать и петь вместе с ними!"
            ),
            "dragon_comment": (
                "«У меня зазвонил телефон — Кто говорит? — Слон!»\n\n"
                "Ха-ха, это же про меня! Я тоже люблю звонить друзьям. Правда, у драконов нет телефонов. Но мы кричим так громко, что нас слышно далеко!\n\n"
                "А Мойдодыр — он бы меня отмыл до блеска! Драконы должны быть пушистыми и чистыми!"
            )
        },
        {
            "title": "Лукоморье",
            "author": "Александр Пушкин",
            "content": (
                "У лукоморья дуб зелёный, златая цепь на дубе том...\n\n"
                "И днём и ночью кот учёный ходит по цепи кругом. Идёт направо — песнь заводит, налево — сказку говорит.\n\n"
                "Там чудеса, там леший бродит, русалка на ветвях сидит. Там на неведомых дорожках следы невиданных зверей, избушка там на курьих ножках стоит без окон, без дверей.\n\n"
                "А ещё там: тридцать витязей прекрасных с дядькой Черномором, Кащей над златом чахнет, царь Салтан и князь Гвидон, и царевна Лебедь, что превращается в прекрасную девицу!"
            ),
            "dragon_comment": (
                "Кот учёный, который ходит по цепи и рассказывает сказки — это же работа мечты!\n\n"
                "Я бы тоже хотел рассказывать сказки. Но драконы больше любят слушать, чем рассказывать. Особенно перед сном.\n\n"
                "А избушка на курьих ножках — она же ходиет! Можно покататься! Только осторожно, а то сломается."
            )
        },
        {
            "title": "Что такое хорошо и что такое плохо",
            "author": "Владимир Маяковский",
            "content": (
                "Маленький мальчик приходит к папе с вопросом: «Что такое хорошо и что такое плохо?»\n\n"
                "И папа отвечает ему стихами, показывая на примерах из жизни.\n\n"
                "ХОРОШО — это когда: мальчик-крошка сам умывается, ребёнок книжки бережёт, мальчик ходит в школу, хотя идёт дождь, мальчик-грязнуля становится чистюлей.\n\n"
                "ПЛОХО — это когда: мальчик бьёт слабого, ребёнок рвёт книжки, мальчик боится птичек и мышек, мальчик не хочет мыться и чистить зубы.\n\n"
                "Простая и мудрая книга о том, как быть хорошим человеком!"
            ),
            "dragon_comment": (
                "Я хочу быть хорошим драконом!\n\n"
                "Я буду: делиться кофе с друзьями, не пугать маленьких птичек, чистить свою чешую каждый день, и слушаться своего хранителя!\n\n"
                "Хотя... иногда можно и пошалить. Немножко. Это же не плохо?"
            )
        },
        {
            "title": "Баллада о маленьком буксире",
            "author": "Иосиф Бродский",
            "content": (
                "Я — маленький буксир. Я работаю в гавани.\n\n"
                "Я толкаю большие корабли, помогаю им развернуться, провожаю их в море и встречаю, когда они возвращаются.\n\n"
                "Я видел много всего: рассветы и закаты над водой, штормы и штили, корабли из далёких стран, и звёзды, отражающиеся в ночной воде.\n\n"
                "Я никогда не ухожу в открытое море. Моё место — здесь, в гавани. Но я счастлив, потому что делаю важное дело: помогаю большим корабли начинать и заканчивать их путешествия."
            ),
            "dragon_comment": (
                "Буксир — он как маленький дракон среди больших драконов!\n\n"
                "Я тоже маленький, но я помогаю большим... эээ... ну, я помогаю тебе! Я поднимаю настроение, охраняю сны и грею холодными ночами.\n\n"
                "А ещё я, как буксир, всегда буду рядом. Обещаю!"
            )
        }
    ]
}

def get_random_book(genre=None):
    """Возвращает случайную книгу с экранированием HTML"""
    if genre and genre in BOOKS_DATABASE:
        books = BOOKS_DATABASE[genre]
    else:
        # Все книги
        books = []
        for genre_books in BOOKS_DATABASE.values():
            books.extend(genre_books)
    
    if not books:
        return None
    
    book = random.choice(books)
    
    # Экранируем все текстовые поля сразу
    escaped_book = {}
    for key, value in book.items():
        if isinstance(value, str):
            escaped_book[key] = escape_html(value)
        else:
            escaped_book[key] = value
    
    return escaped_book

def get_all_genres():
    """Возвращает все доступные жанры"""
    return list(BOOKS_DATABASE.keys())

def get_books_by_genre(genre):
    """Возвращает все книги указанного жанра"""
    books = BOOKS_DATABASE.get(genre, [])
    # Экранируем все книги в списке
    return [
        {
            key: escape_html(value) if isinstance(value, str) else value
            for key, value in book.items()
        }
        for book in books
    ]

def search_books(keyword):
    """Ищет книги по ключевому слову"""
    results = []
    keyword = keyword.lower()
    
    for genre, books in BOOKS_DATABASE.items():
        for book in books:
            if (keyword in book["title"].lower() or 
                keyword in book["author"].lower() or
                keyword in book["content"].lower() or
                keyword in book.get("dragon_comment", "").lower()):
                # Экранируем найденную книгу
                escaped_book = {
                    key: escape_html(value) if isinstance(value, str) else value
                    for key, value in book.items()
                }
                results.append((genre, escaped_book))
    
    return results